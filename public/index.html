<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ðŸ“Š PSX Dashboard</title>
<style>
body { font-family: sans-serif; background:#f7f8fa; padding:20px }
nav button { margin-right:8px; padding:6px 10px; border:none; border-radius:4px; cursor:pointer }
.active { background:#0366d6; color:white }
table { width:100%; border-collapse:collapse; margin-top:8px }
th,td { padding:6px 8px; border-bottom:1px solid #eee; text-align:left }
.new { background:#e7ffe7 }
.loss { color:red }
.profit { color:green }
.card { background:white; padding:12px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-top:10px }
.filters input, .filters select, .filters button { margin:4px; padding:5px }
</style>
</head>
<body>

<h2>ðŸ“Š PSX Portfolio & Volume Leaders</h2>

<nav>
  <button id="tabPortfolio" class="active">Portfolio</button>
  <button id="tabLeaders">Volume Leaders</button>
</nav>

<!-- PORTFOLIO TAB -->
<div id="portfolioTab" class="card">
  <h3>Your Portfolio</h3>
  <form id="addForm">
    <input id="symbol" placeholder="Symbol" required>
    <input id="qty" type="number" placeholder="Qty" required>
    <input id="buyPrice" type="number" step="0.01" placeholder="Buy Price (Rs)" required>
    <button>Add/Update</button>
  </form>
  <div id="portfolioTable"></div>

  <h3 style="margin-top:20px;">ðŸ“œ Trade History</h3>
  <div class="filters">
    <input id="filterSymbol" placeholder="Symbol (e.g. ATRL)">
    <select id="filterType">
      <option value="">All</option>
      <option value="Buy">Buy</option>
      <option value="Sell">Sell</option>
    </select>
    <input id="filterFrom" type="date">
    <input id="filterTo" type="date">
    <button type="button" onclick="loadTrades()">Filter</button>
  </div>

  <table border="1" id="tradesTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Type</th>
        <th>Symbol</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Proceeds</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- LEADERS TAB -->
<div id="leadersTab" class="card" style="display:none">
  <h3>ðŸ”¥ Volume Leaders (Latest)</h3>
  <button id="refreshLeaders">ðŸ”„ Refresh</button>
  <div id="leadersTable" style="margin-top:10px;"></div>
</div>

<body onload="loadSnapshot()">
  <button onclick="loadSnapshot()">ðŸ”„ Refresh</button>
  <div id="leaders"></div>
</body>

<script>
document.getElementById('tabPortfolio').onclick = ()=>switchTab('portfolio');
document.getElementById('tabLeaders').onclick = ()=>switchTab('leaders');

function switchTab(tab){
  document.getElementById('portfolioTab').style.display = tab==='portfolio'?'block':'none';
  document.getElementById('leadersTab').style.display = tab==='leaders'?'block':'none';
  document.getElementById('tabPortfolio').classList.toggle('active', tab==='portfolio');
  document.getElementById('tabLeaders').classList.toggle('active', tab==='leaders');
  if(tab==='leaders') loadLeaders();
}

let currentBalance = 0;

// ---- PORTFOLIO ----
async function loadPortfolio(){
  const r = await fetch('/api/portfolio');
  const data = await r.json();
  currentBalance = data.balance || 0;
  const arr = data.stocks || [];
  let totalProfit = 0, totalInvest = 0;
  let html = `<p><b>ðŸ’° Balance:</b> Rs ${currentBalance.toFixed(2)}</p>`;
  html += '<table><tr><th>Symbol</th><th>Qty</th><th>Buy Price</th><th>Current</th><th>P/L Rs</th><th>P/L %</th><th>Action</th></tr>';
  for(const p of arr){
    totalInvest += p.buyPrice * p.qty;
    if(p.profit) totalProfit += p.profit;
    const cls = p.profit>0 ? 'profit' : 'loss';
    html += `<tr>
      <td>${p.symbol}</td>
      <td>${p.qty}</td>
      <td>${p.buyPrice}</td>
      <td>${p.current ?? 'N/A'}</td>
      <td class="${cls}">${p.profit?.toFixed(2) ?? '-'}</td>
      <td class="${cls}">${p.profitPct ?? '-'}%</td>
      <td><button onclick="sellStock('${p.symbol}',${p.current||p.buyPrice})">Sell</button></td>
    </tr>`;
  }
  html += `</table>
  <p><b>Total Invested:</b> Rs ${totalInvest.toFixed(2)}<br>
  <b>Total P/L:</b> <span class="${totalProfit>=0?'profit':'loss'}">Rs ${totalProfit.toFixed(2)}</span></p>`;
  document.getElementById('portfolioTable').innerHTML = html;
}

document.getElementById('addForm').onsubmit = async e=>{
  e.preventDefault();
  const body = {
    symbol: document.getElementById('symbol').value.trim().toUpperCase(),
    qty: +document.getElementById('qty').value,
    buyPrice: +document.getElementById('buyPrice').value
  };
  const r = await fetch('/api/portfolio', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });
  const res = await r.json();
  if(res.error) alert(res.error);
  else loadPortfolio();
  e.target.reset();
};

async function sellStock(symbol, defaultPrice){
  const input = prompt(`Enter selling price for ${symbol}:`, defaultPrice || '');
  if (!input) return;
  const sellPrice = parseFloat(input);
  if (isNaN(sellPrice) || sellPrice <= 0) return alert('Invalid price!');
  const r = await fetch(`/api/portfolio/${symbol}`, {
    method:'DELETE',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ sellPrice })
  });
  const res = await r.json();
  if (res.error) alert(res.error);
  else alert(`âœ… Sold ${symbol} @ Rs ${sellPrice}. New Balance: Rs ${res.newBalance.toFixed(2)}`);
  loadPortfolio();
  loadTrades();
}
async function loadSnapshot() {
  const container = document.getElementById("leaders");
  container.innerHTML = "Loading...";

  try {
    const res = await fetch("/api/snapshot");
    const data = await res.json();

    if (data.error) {
      container.innerHTML = `<p style="color:red">${data.error}</p>`;
      return;
    }

    let html = `<h2>ðŸ”¥ Volume Leaders (${data.date})</h2>`;
    html += `<table border="1" cellspacing="0" cellpadding="6">
      <tr><th>Symbol</th><th>Volume</th></tr>
      ${data.volumeLeaders
        .map(
          (s) => `<tr><td>${s.symbol}</td><td>${s.volume}</td></tr>`
        )
        .join("")}
    </table>`;

    if (data.newEntries && data.newEntries.length > 0) {
      html += `<h3 style="color:green;margin-top:20px">ðŸ†• New Entries vs Yesterday</h3>`;
      html += `<table border="1" cellspacing="0" cellpadding="6">
        <tr><th>Symbol</th><th>Volume</th></tr>
        ${data.newEntries
          .map(
            (s) => `<tr style="background:#e8ffe8"><td>${s.symbol}</td><td>${s.volume}</td></tr>`
          )
          .join("")}
      </table>`;
    } else {
      html += `<p style="margin-top:10px;color:#888">No new entries today âœ…</p>`;
    }

    container.innerHTML = html;
  } catch (err) {
    console.error(err);
    container.innerHTML = `<p style="color:red">Error loading leaders!</p>`;
  }
}

// ---- TRADE HISTORY ----
async function loadTrades() {
  const params = new URLSearchParams({
    symbol: document.getElementById("filterSymbol").value,
    type: document.getElementById("filterType").value,
    from: document.getElementById("filterFrom").value,
    to: document.getElementById("filterTo").value
  });
  const res = await fetch(`/api/trades?${params}`);
  const data = await res.json();
  const tbody = document.querySelector("#tradesTable tbody");
  tbody.innerHTML = (data.trades || []).map(t => `
    <tr>
      <td>${new Date(t.date).toLocaleString()}</td>
      <td>${t.type}</td>
      <td>${t.symbol}</td>
      <td>${t.qty}</td>
      <td>${t.price}</td>
      <td>${t.proceeds ? t.proceeds.toFixed(2) : "-"}</td>
    </tr>
  `).join("");
}

// ---- VOLUME LEADERS ----
async function loadLeaders(){
  try {
    const r = await fetch('/api/snapshot');
    const j = await r.json();
    const leaders = j.volumeLeaders || [];
    if (leaders.length === 0) {
      document.getElementById('leadersTable').innerHTML = '<p>No data found. Run <code>node fetchData.js</code> to fetch latest leaders.</p>';
      return;
    }
    let html = '<table><tr><th>Symbol</th><th>Volume</th></tr>';
    for (const v of leaders) {
      html += `<tr><td>${v.Symbol || v.symbol}</td><td>${v.Volume || v.volume}</td></tr>`;
    }
    html += '</table>';
    document.getElementById('leadersTable').innerHTML = html;
  } catch (err) {
    document.getElementById('leadersTable').innerHTML = '<p style="color:red">Error loading leaders!</p>';
  }
}

document.getElementById('refreshLeaders').onclick = loadLeaders;

// ---- INITIAL LOAD ----
loadPortfolio();
loadTrades();
</script>
</body>
</html>
